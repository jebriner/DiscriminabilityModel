rm(list=ls(all=T))cat("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPlease select the softare you use. For those following the demonstration enter 1.\n")switch(menu(c("SpectraWin.", "OOIBase32.", "Excel Spreadsheet")), SWtype<-(1), SWtype<-(2), SWtype<-(3))# Enables you to select the software type.if(SWtype!=3){switch(menu(c("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPress 1 and then Return.  Then open any file in your data folder.   For those\npeople following the demonstration, open any file in the Ascii files folder in\nData Folder.\n")), ASCIIfiles<-file.choose())# A menu of one selection (1), which enables you to find a file.alldata<-list.files(dirname(ASCIIfiles))# Lists all files in the directory of the file you just opened.if(SWtype==1){tttfiles<-alldata[grep("\.ttt$", alldata)]seperate<-c(";") trash<-6fr<-8fn<-4wav<-5addy<-0}# Finds all Spectrawin files (.ttt) and specifies the seperataors (;), the number # of lines of trash (6), the number of characters after the experiment name (8),# the number of characters after the filenumber (4), and the column in which the # reflectanvce data is stored (5).if(SWtype==2){tttfiles<-alldata[grep("\.Master.transmission$", alldata)]seperate<-c("	") trash<-14fr<-26fn<-20wav<-2addy<-1}# Finds all OOIBase32 files (.Master.transmission) and specifies the seperataors# (tab), the number of lines of trash (14), the number of characters after the # experiment name (26), the number of characters after the filenumber (20), and # the column in which the reflectanvce data is stored (2).}if(SWtype==3){switch(menu(c("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPress 1 and then Return.  Then open the Excel file that contains the reflectance data.\n")), ASCIIfiles<-file.choose())alldata<-data.frame(read.csv(ASCIIfiles, header=F))attach(alldata)tttfiles<-c(2:ncol(alldata))wav<-2addy<-0}cat("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPlease select a number. For those following the demonstration select 1.\n")switch(menu(c("Use Blue Tit cone sensitivities.", "Use Blue Tit double cone sensitivity.", "Use Chicken Cone sensitivities.", "Use Chicken double cone sensitivity.", "Use Human cone sensitivities.", "Use own cone sensitivities." )), Conesensitivitiesfilepath<-paste(dirname(dirname(dirname(ASCIIfiles))), .Platform$file.sep, "Cone sensitivities", .Platform$file.sep, "Blue Tit Cones", sep=""), Conesensitivitiesfilepath<-paste(dirname(dirname(dirname(ASCIIfiles))), .Platform$file.sep, "Cone sensitivities", .Platform$file.sep, "Blue Tit Double Cone", sep=""), Conesensitivitiesfilepath<-paste(dirname(dirname(dirname(ASCIIfiles))), .Platform$file.sep, "Cone sensitivities", .Platform$file.sep, "Chicken cones", sep=""), Conesensitivitiesfilepath<-paste(dirname(dirname(dirname(ASCIIfiles))), .Platform$file.sep, "Cone sensitivities", .Platform$file.sep, "Chicken Double cone", sep=""), Conesensitivitiesfilepath<-paste(dirname(dirname(dirname(ASCIIfiles))), .Platform$file.sep, "Cone sensitivities", .Platform$file.sep, "Human Cones", sep=""), Conesensitivitiesfilepath<-file.choose())# Alows you to choose between cone sensitivities in the library and your own.Lamprey<-(1)cat("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPlease select a number.\n")switch(menu(c("Take into account the transmittance of the ocular media", "Disregard the ocular media." )), switch(menu(c("Use Blue Tit data", "Use Own data" )), Ocularfilepath<-paste(dirname(dirname(dirname(ASCIIfiles))), .Platform$file.sep, "Cone sensitivities", .Platform$file.sep, "Blue Tit Ocular", sep=""), Ocularfilepath<-file.choose()), Lamprey<-(0))# Alows you to choose between ocular media transmittances in the library, your own # ocular media transmittances or to disregard the ocular media.  If the latter the# vector Lamprey becomes (0)Hagfish<-(1)cat("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPlease select a number.\n")switch(menu(c("Take into account the irradiance spectrum", "Disregard the irradiance spectrum." )), switch(menu(c("Use Daylight", "Use Forest Shade", "Use Blue Sky", "Use Own data" )), Irrfilepath<-paste(dirname(dirname(dirname(ASCIIfiles))), .Platform$file.sep, "Cone sensitivities", .Platform$file.sep, "Daylight", sep=""), Irrfilepath<-paste(dirname(dirname(dirname(ASCIIfiles))), .Platform$file.sep, "Cone sensitivities", .Platform$file.sep, "Forest Shade", sep=""),Irrfilepath<-paste(dirname(dirname(dirname(ASCIIfiles))), .Platform$file.sep, "Cone sensitivities", .Platform$file.sep, "Use Blue Sky", sep=""),Irrfilepath<-file.choose()), Hagfish<-(0))# Alows you to choose between irradiance spectra in the library, your own # irradiance spectra or to disregard the irradiance.  If the latter the# vector Hagfish becomes (0)VK<-0if(Hagfish==1){switch(menu(c("Apply a von Kreis colour constancy algorithm to the data", "Do not take into account colour constancy")), VK<-1, VK<-0)}file.test <- TRUEsetwd(dirname(dirname(ASCIIfiles)))# Sets the working directory to the parent directory of the data folder.while (file.test){	cat("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPlease enter a name for the output file, then press Return.  For those people\nfollowing the demonstration I suggest using the file name coneoutput.dem.\n", file="")Outputfilepath<-c(paste(dirname(dirname(ASCIIfiles)), .Platform$file.sep, fnam<-scan(n=1, what="character", quiet=1), sep=""))# Creates a file path (the parent directory of the data folder), a file path# separator,  and a file name of your choice.	if(file.exists(fnam)) {		cat("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nA file by this name already exists, please select a number.\n", file="")switch(menu(c("Rename file.", "Over write the current file.")), file.test<-TRUE, file.test<-FALSE)}	else {file.test <- FALSE}}# If this file already exists then there is the option of overwriting or renaming # the file. If you rename file.test goes to TRUE and is fed back into the loop. # If the file name does not already exist or you choose to overwrite file.test # goes to FALSE and you exit the loop.cabbage<-data.frame(read.csv(Conesensitivitiesfilepath, sep=","))attach(cabbage)cat(file= Outputfilepath, "a", ",", "b", ",", "c", ",", "d", ",", "e", "\n", append=FALSE, sep="")cat(file= Outputfilepath, "Data Set", ",", basename(dirname(ASCIIfiles)), "\n", append=TRUE, sep="")cat(file= Outputfilepath, "Cone sensitivities", ",", basename(Conesensitivitiesfilepath), "\n", append=TRUE, sep="")if (Lamprey==1){cat(file= Outputfilepath, "Ocular Media", ",", basename(Ocularfilepath), "\n", append=TRUE, sep="")}if (Lamprey==0){cat(file= Outputfilepath, "Ocular Media", ",", "Disregarded", "\n", append=TRUE, sep="")}if (Hagfish==1){cat(file= Outputfilepath, "Irradiance Spectra", ",", basename(Irrfilepath), "\n", append=TRUE, sep="")}if (Hagfish==0){cat(file= Outputfilepath, "Irradiance Spectra", ",", "Disregarded", "\n", append=TRUE, sep="")}if (VK==1){cat(file= Outputfilepath, "Von Kreis Transformed", ",", "TRUE", "\n", append=TRUE, sep="")}if (VK==0){cat(file= Outputfilepath, "Von Kreis Transformed", ",", "FALSE", "\n", append=TRUE, sep="")}# Opens the data of cone sensitivities.nocones<-as.numeric(length(names(cabbage)))# Determines the number of cones being used.# Writes the first two column headers to the output file.# Writes the remaining headers depending on how many cones.if(SWtype!=3){template<-data.frame(read.csv(paste(dirname(ASCIIfiles), .Platform$file.sep, tttfiles[1], sep=""), sep=as.character(seperate), skip=as.numeric(trash)))attach(template)}if(SWtype==3){template<-data.frame(rbind(  cbind(as.numeric(as.character(alldata[,1][-c(1:2)])), as.numeric(as.character(alldata[,tttfiles[1]][-c(1:2)]))),c(1, 2)))}# Opens the first file in order to determine the reference points for wavelength# against the cone sensitivity, ocular media and irradiance spectrum wavelengths. template<-data.frame(X.nm.= as.numeric(as.character(template[[1]][-length(template[[1]])])), X...transmittance.= as.numeric(as.character(template[[wav]][-length(template[[1]])])))# Creates a data frame of wavelength and %reflctance from the data file.  The last # data point is removed because for OOIBase32 files this is text.template<-data.frame(X.nm.=template$X.nm.[template$X.nm.>as.numeric(as.character(cabbage[,1][1])) & template$X.nm.<as.numeric(as.character(cabbage[,1][length(cabbage[,1])]))], X...transmittance.=template$X...transmittance.[template$X.nm.>as.numeric(as.character(cabbage[,1][1])) & template$X.nm.<as.numeric(as.character(cabbage[,1][length(cabbage[,1])]))])# Creates a subset of the data frame for wavelengths between 300 and 700nmsens <- cabbage[round(approx(cabbage[,1], 1:length(cabbage[,1]), xout=template$X.nm., rule=2,ties='ordered')$y), 2:nocones]# Matches wavelengths from the data file with those in the cone sensitivity and # displays them for the no of cones.if(Lamprey==1){calpper<-data.frame(read.csv(Ocularfilepath, sep=","))attach(calpper)senile<- calpper[round(approx(calpper[,1], 1:length(calpper[,1]), xout=template$X.nm., rule=2,ties='ordered')$y), 2]}if(Lamprey==0){senile<-rep(1, as.numeric(length(template$X.nm.)))}# If the occular media is regarded wavelengths from the data file are matched with# those ocular media transmittance data.  If it is disregarded a vector of 1's is # created which is the same length as the vector of wavelengths from the data fileif(Hagfish==1){Haggly<-data.frame(read.csv(Irrfilepath, sep=","))attach(Haggly)seniler<- Haggly[round(approx(Haggly[,1], 1:length(Haggly[,1]), xout=template$X.nm., rule=2,ties='ordered')$y), 2]}if(Hagfish==0){seniler<-rep(1, as.numeric(length(template$X.nm.)))}# If the irradiance spectra is regarded wavelengths from the data file are matched# with those ocular media transmittance data.  If it is disregarded a vector of # 1's is created which is the same length as the vector of wavelengths from the # data fileIrroutputs<-c("VSVK", "SVK", "MVK", "LVK")VSVK<-c(1)SVK<-c(1)MVK<-c(1)LVK<-c(1)if(VK==1){hik<-cbind(senile, seniler, sens)for(gh in 1:(nocones-1)){assign(as.character(Irroutputs[gh]), sum(hik[,1]*hik[,2]*hik[,(gh+2)])/sum(hik[,(gh+2)]))}}if(VK==0){for(gh in 1:(nocones-1)){assign(as.character(Irroutputs[gh]), 1)}}cat(file= Outputfilepath, "Von Kreis Denominators", ",", append=TRUE, sep="")for (qt in 1:(nocones-1)){if (qt==(nocones-1)){cat(file= Outputfilepath, eval(as.name(Irroutputs[qt])), ",", "\n", append=TRUE, sep="")}else {cat(file= Outputfilepath, eval(as.name(Irroutputs[qt])), ",", append=TRUE, sep="")}}cat(file= Outputfilepath, "Exp.No", ",", "filenumber",  ",", append=TRUE, sep="")for(x in 2:nocones){if(x==nocones){cat(file= Outputfilepath, names(cabbage)[x], "\n", append=TRUE, sep="")}else { cat(file= Outputfilepath, names(cabbage)[x], ",", append=TRUE)}}cat("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nThe data is being processed, please wait.\n", file="")for(haji in 1:length(tttfiles)){# Iterates through the data files.if(SWtype!=3){mana<-data.frame(read.csv(paste(dirname(ASCIIfiles), .Platform$file.sep, tttfiles[haji], sep=""), sep=as.character(seperate), skip=as.numeric(trash)))attach(mana)fileroot<-substr(tttfiles[haji], 1,(nchar(tttfiles[haji])-fr))# Reads off the file name except the last (fr) characters (ie. The file number and suffixfilenumberer<-as.numeric(substr(tttfiles[haji], (nchar(tttfiles[haji])-(fr-1-addy)), (nchar(tttfiles[haji])-fn)))# Reads off the file number# Finds the first non-zero number within the file number (the last charcter is # excluded because the first OOIBase32 files actually have the number 0. }if(SWtype==3){mana<-data.frame(rbind(cbind(as.numeric(as.character(alldata[,1][-c(1:2)])), as.numeric(as.character(alldata[,tttfiles[haji]][-c(1:2)]))),c(1, 2)))fileroot<-as.character(alldata[,tttfiles[haji]][1])filenumberer<-as.numeric(as.character(alldata[,tttfiles[haji]][2]))}# opens and attaches the data filemana<-data.frame(X.nm.= as.numeric(as.character(mana[[1]][-length(mana[[1]])])), X...transmittance.= as.numeric(as.character(mana[[wav]][-length(mana[[1]])])))# Creates a data frame of wavelength and % reflectancemana<-data.frame(X.nm.=mana$X.nm.[mana$X.nm.>as.numeric(as.character(cabbage[,1][1])) & mana$X.nm.<as.numeric(as.character(cabbage[,1][length(cabbage[,1])]))], X...transmittance.=mana$X...transmittance.[mana$X.nm.>as.numeric(as.character(cabbage[,1][1])) & mana$X.nm.<as.numeric(as.character(cabbage[,1][length(cabbage[,1])]))])# Creates a subset of the dataframe for wavelengths between 300 and 700nmadder<-cbind(mana[,2], seniler, senile, sens)# Creates a matrix of the reflectance data with the corresponding transmittance# and sensitivities of the ocular media, irradiance spectra and cones. namesof<-c("UVcone", "SWcone", "MWcone", "LWcone")# Creates a vetor with 4 items.county<-c(3)for(lala in 1:as.numeric(nocones-1)){county<-county+1assign(as.character(namesof[lala]), ((sum(adder[,1]*adder[,2]*adder[,3]*adder[,county])/(sum(adder[,county])*100))/eval(as.name(Irroutputs[lala]))))}# This itterates through the cones and calculates the outputs, the outputs are# given the name UVcone, SWcone, MWcone, LWcone.# This integrates the reflectance spectrum.cat(file= Outputfilepath, fileroot, ",", filenumberer+addy,  ",", append=TRUE, sep="")# Outputs the filename and number to an output file.for(lik in 1:as.numeric(nocones-1)){if(lik==nocones-1){cat(file= Outputfilepath, eval(as.name(namesof[lik])), "\n", append=TRUE, sep="")}else { cat(file= Outputfilepath, eval(as.name(namesof[lik])), ",", append=TRUE, sep="")}}# Writes the data to the output file.if(SWtype!=3){detach(mana)}}try<-data.frame(read.csv(Outputfilepath, sep=",", skip=7))attach(try)heady<-read.csv(Outputfilepath, sep=",")switch(menu(c("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPress 1 and then Return to see the cone output data on the R console")), print(try))switch(menu(c("Press 1 and then Return to see information concerning the data on the R console")), print(heady[1:6,]))